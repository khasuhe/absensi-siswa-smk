<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi SMK ASSUYTHIYYAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .login-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen login-bg flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-white font-bold text-2xl">SA</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">SMK ASSUYTHIYYAH</h1>
                <p class="text-gray-600 mt-2">Sistem Absensi Siswa</p>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <form onsubmit="handleLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="login-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan username" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan password" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium transition-colors">
                        Masuk
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">Belum punya akun? 
                        <button onclick="showRegister()" class="text-purple-600 hover:text-purple-700 font-medium">Daftar di sini</button>
                    </p>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <form onsubmit="handleRegister(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="register-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Pilih username" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="register-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan email" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="register-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Buat password" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Konfirmasi Password</label>
                        <input type="password" id="register-confirm" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Konfirmasi password" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-medium transition-colors">
                        Daftar
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">Sudah punya akun? 
                        <button onclick="showLogin()" class="text-purple-600 hover:text-purple-700 font-medium">Masuk di sini</button>
                    </p>
                </div>
            </div>

            <!-- Demo Account Info -->
            <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                <h4 class="text-sm font-medium text-blue-800 mb-2">Akun Demo:</h4>
                <p class="text-xs text-blue-600">Username: admin</p>
                <p class="text-xs text-blue-600">Password: admin123</p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden initially) -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 sm:px-6 py-3 sm:py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-purple-600 font-bold text-lg sm:text-xl">SA</span>
                        </div>
                        <div class="min-w-0">
                            <h1 class="text-lg sm:text-2xl font-bold truncate">SMK ASSUYTHIYYAH</h1>
                            <p class="text-purple-100 text-xs sm:text-sm hidden sm:block">Sistem Absensi Siswa Otomatis</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-medium" id="user-display">Admin</p>
                            <p class="text-xs text-purple-200">Online</p>
                        </div>
                        <button onclick="handleLogout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 sm:px-4 py-2 rounded-lg text-sm transition-colors">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-2 sm:px-6">
                <div class="flex justify-center space-x-1 sm:space-x-2 overflow-x-auto">
                    <button onclick="showSection('dashboard')" class="nav-btn py-2 sm:py-3 px-3 sm:px-6 text-purple-600 bg-purple-50 rounded-lg font-medium transition-all duration-200 text-xs sm:text-sm whitespace-nowrap">üìä <span class="hidden sm:inline">Dashboard</span></button>
                    <button onclick="showSection('input-data')" class="nav-btn py-2 sm:py-3 px-3 sm:px-6 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg font-medium transition-all duration-200 text-xs sm:text-sm whitespace-nowrap">üìù <span class="hidden sm:inline">Input Data</span></button>
                    <button onclick="showSection('absensi')" class="nav-btn py-2 sm:py-3 px-3 sm:px-6 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg font-medium transition-all duration-200 text-xs sm:text-sm whitespace-nowrap">‚úÖ <span class="hidden sm:inline">Absensi</span></button>
                    <button onclick="showSection('output')" class="nav-btn py-2 sm:py-3 px-3 sm:px-6 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg font-medium transition-all duration-200 text-xs sm:text-sm whitespace-nowrap">üìà <span class="hidden sm:inline">Rekap</span></button>
                </div>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 sm:mb-8">Dashboard</h2>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
                    <div class="bg-white rounded-lg p-3 sm:p-6 card-shadow hover-scale">
                        <div class="flex items-center">
                            <div class="p-2 sm:p-3 rounded-full bg-blue-100 text-blue-600 flex-shrink-0">
                                <svg class="w-5 h-5 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="ml-2 sm:ml-4 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Kepala Sekolah</p>
                                <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="totalKepsek">1</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-3 sm:p-6 card-shadow hover-scale">
                        <div class="flex items-center">
                            <div class="p-2 sm:p-3 rounded-full bg-green-100 text-green-600 flex-shrink-0">
                                <svg class="w-5 h-5 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                </svg>
                            </div>
                            <div class="ml-2 sm:ml-4 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Total Guru</p>
                                <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="totalGuru">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-3 sm:p-6 card-shadow hover-scale">
                        <div class="flex items-center">
                            <div class="p-2 sm:p-3 rounded-full bg-yellow-100 text-yellow-600 flex-shrink-0">
                                <svg class="w-5 h-5 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                                </svg>
                            </div>
                            <div class="ml-2 sm:ml-4 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Total Siswa</p>
                                <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="totalSiswa">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-3 sm:p-6 card-shadow hover-scale col-span-2 lg:col-span-1">
                        <div class="flex items-center">
                            <div class="p-2 sm:p-3 rounded-full bg-purple-100 text-purple-600 flex-shrink-0">
                                <svg class="w-5 h-5 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"/>
                                </svg>
                            </div>
                            <div class="ml-2 sm:ml-4 min-w-0">
                                <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Kehadiran Hari Ini</p>
                                <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="kehadiranHariIni">0%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white rounded-lg p-4 sm:p-6 card-shadow">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Grafik Kehadiran Mingguan</h3>
                    <div class="relative h-64 sm:h-80">
                        <canvas id="attendanceChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Data Section -->
        <div id="input-data" class="section hidden">
            <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 sm:mb-8">Input Data</h2>
                
                <!-- Upload Excel -->
                <div class="bg-white rounded-lg p-4 sm:p-6 card-shadow mb-6 sm:mb-8">
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Upload Data Excel</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4 mb-4">
                        <button onclick="downloadTemplate('guru')" class="bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded-lg text-sm">Template Guru</button>
                        <button onclick="downloadTemplate('siswa')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 sm:px-4 py-2 rounded-lg text-sm">Template Siswa</button>
                        <button onclick="downloadTemplate('mapel')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 sm:px-4 py-2 rounded-lg text-sm">Template Mapel</button>
                    </div>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                    <button onclick="uploadExcel()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base w-full sm:w-auto">Upload & Import</button>
                </div>

                <!-- Tabs for different data types -->
                <div class="bg-white rounded-lg card-shadow">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-2 sm:space-x-8 px-2 sm:px-6 overflow-x-auto">
                            <button onclick="showInputTab('kepsek')" class="input-tab-btn py-3 sm:py-4 px-2 sm:px-2 border-b-2 border-purple-600 text-purple-600 font-medium text-xs sm:text-sm whitespace-nowrap">Kepala Sekolah</button>
                            <button onclick="showInputTab('guru')" class="input-tab-btn py-3 sm:py-4 px-2 sm:px-2 text-gray-500 hover:text-gray-700 font-medium text-xs sm:text-sm whitespace-nowrap">Guru</button>
                            <button onclick="showInputTab('siswa')" class="input-tab-btn py-3 sm:py-4 px-2 sm:px-2 text-gray-500 hover:text-gray-700 font-medium text-xs sm:text-sm whitespace-nowrap">Siswa</button>
                            <button onclick="showInputTab('mapel')" class="input-tab-btn py-3 sm:py-4 px-2 sm:px-2 text-gray-500 hover:text-gray-700 font-medium text-xs sm:text-sm whitespace-nowrap">Mata Pelajaran</button>
                        </nav>
                    </div>

                    <!-- Kepala Sekolah Form -->
                    <div id="kepsek-form" class="input-tab p-4 sm:p-6">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">Data Kepala Sekolah</h3>
                        <form onsubmit="saveKepsek(event)" class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-6">
                            <input type="text" id="kepsek-nip" placeholder="NIP/NUPTK" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base" required>
                            <input type="text" id="kepsek-nama" placeholder="Nama Lengkap" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base" required>
                            <select id="kepsek-gender" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base" required>
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                            <input type="text" id="kepsek-alamat" placeholder="Alamat" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base" required>
                            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 sm:px-6 py-2 rounded-lg sm:col-span-2 text-sm sm:text-base">Simpan Data</button>
                        </form>
                        <div id="kepsek-list" class="overflow-x-auto">
                            <table class="min-w-full bg-white text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIP/NUPTK</th>
                                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kelamin</th>
                                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alamat</th>
                                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="kepsek-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Guru Form -->
                    <div id="guru-form" class="input-tab p-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Guru</h3>
                        <form onsubmit="saveGuru(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <input type="text" id="guru-nip" placeholder="NIP/NUPTK" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <input type="text" id="guru-nama" placeholder="Nama Lengkap" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <select id="guru-gender" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                            <input type="text" id="guru-alamat" placeholder="Alamat" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg md:col-span-2">Simpan Data</button>
                        </form>
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-medium text-gray-700">Daftar Guru</h4>
                            <button onclick="downloadData('guru')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">Download Data</button>
                        </div>
                        <div id="guru-list" class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIP/NUPTK</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kelamin</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alamat</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="guru-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Siswa Form -->
                    <div id="siswa-form" class="input-tab p-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Siswa</h3>
                        <form onsubmit="saveSiswa(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <input type="text" id="siswa-nis" placeholder="NIS" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <input type="text" id="siswa-nisn" placeholder="NISN" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <input type="text" id="siswa-nama" placeholder="Nama Lengkap" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <select id="siswa-gender" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                            <input type="text" id="siswa-kelas" placeholder="Kelas (contoh: X-TKJ-1)" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg">Simpan Data</button>
                        </form>
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-medium text-gray-700">Daftar Siswa</h4>
                            <button onclick="downloadData('siswa')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">Download Data</button>
                        </div>
                        <div id="siswa-list" class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kelamin</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="siswa-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mata Pelajaran Form -->
                    <div id="mapel-form" class="input-tab p-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Mata Pelajaran</h3>
                        <form onsubmit="saveMapel(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <input type="text" id="mapel-kode" placeholder="Kode Mata Pelajaran" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <input type="text" id="mapel-nama" placeholder="Nama Mata Pelajaran" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg md:col-span-2">Simpan Data</button>
                        </form>
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-medium text-gray-700">Daftar Mata Pelajaran</h4>
                            <button onclick="downloadData('mapel')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">Download Data</button>
                        </div>
                        <div id="mapel-list" class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Mata Pelajaran</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="mapel-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Absensi Section -->
        <div id="absensi" class="section hidden">
            <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 sm:mb-8">Absensi Siswa</h2>
                
                <!-- Absensi Header -->
                <div class="bg-white rounded-lg p-4 sm:p-6 card-shadow mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                        <select id="absensi-guru" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base">
                            <option value="">Pilih Guru</option>
                        </select>
                        <input type="date" id="absensi-tanggal" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base">
                        <select id="absensi-mapel" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base">
                            <option value="">Pilih Mata Pelajaran</option>
                        </select>
                        <select id="absensi-kelas" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base">
                            <option value="">Pilih Kelas</option>
                        </select>
                    </div>
                    <button onclick="loadAbsensiSiswa()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base w-full sm:w-auto">Muat Data Siswa</button>
                </div>

                <!-- Absensi Info -->
                <div id="absensi-info" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg p-4 sm:p-6 mb-6 hidden">
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 text-center">
                        <div>
                            <p class="text-xs sm:text-sm opacity-90">Guru</p>
                            <p class="text-sm sm:text-lg font-semibold truncate" id="info-guru">-</p>
                        </div>
                        <div>
                            <p class="text-xs sm:text-sm opacity-90">Tanggal</p>
                            <p class="text-sm sm:text-lg font-semibold" id="info-tanggal">-</p>
                        </div>
                        <div>
                            <p class="text-xs sm:text-sm opacity-90">Mata Pelajaran</p>
                            <p class="text-sm sm:text-lg font-semibold truncate" id="info-mapel">-</p>
                        </div>
                        <div>
                            <p class="text-xs sm:text-sm opacity-90">Kelas</p>
                            <p class="text-sm sm:text-lg font-semibold" id="info-kelas">-</p>
                        </div>
                    </div>
                </div>

                <!-- Absensi Grid -->
                <div id="absensi-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4"></div>
                
                <div id="absensi-actions" class="mt-6 text-center hidden">
                    <button onclick="saveAbsensi()" class="bg-green-600 hover:bg-green-700 text-white px-6 sm:px-8 py-2 sm:py-3 rounded-lg text-base sm:text-lg font-medium w-full sm:w-auto">Simpan Absensi</button>
                </div>
            </div>
        </div>

        <!-- Output Section -->
        <div id="output" class="section hidden">
            <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 sm:mb-8">Rekap & Output</h2>
                
                <!-- Filter Controls -->
                <div class="bg-white rounded-lg p-4 sm:p-6 card-shadow mb-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">Filter Rekap</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                        <select id="filter-kelas" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base">
                            <option value="">Semua Kelas</option>
                        </select>
                        <select id="filter-bulan" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base">
                            <option value="">Pilih Bulan</option>
                            <option value="01">Januari</option>
                            <option value="02">Februari</option>
                            <option value="03">Maret</option>
                            <option value="04">April</option>
                            <option value="05">Mei</option>
                            <option value="06">Juni</option>
                            <option value="07">Juli</option>
                            <option value="08">Agustus</option>
                            <option value="09">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                        <select id="filter-tahun" class="border border-gray-300 rounded-lg px-3 sm:px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm sm:text-base">
                            <option value="">Pilih Tahun</option>
                        </select>
                        <button onclick="generateRekap()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base">Generate Rekap</button>
                    </div>
                </div>

                <!-- Export Controls -->
                <div class="bg-white rounded-lg p-4 sm:p-6 card-shadow mb-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">Export Data</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                        <button onclick="exportToExcel('bulanan')" class="bg-green-600 hover:bg-green-700 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base">Export Rekap Bulanan</button>
                        <button onclick="exportToExcel('tahunan')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base">Export Rekap Tahunan</button>
                        <button onclick="exportToExcel('harian')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base">Export Rekap Harian</button>
                    </div>
                </div>

                <!-- Preview Rekap -->
                <div id="rekap-preview" class="bg-white rounded-lg p-4 sm:p-6 card-shadow">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4">Preview Rekap Absensi</h3>
                    <div id="rekap-content" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-8 text-sm sm:text-base">Pilih filter dan klik "Generate Rekap" untuk melihat data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let dataKepsek = [];
        let dataGuru = [];
        let dataSiswa = [];
        let dataMapel = [];
        let dataAbsensi = [];
        let currentEditId = null;
        let currentEditType = null;
        let currentUser = null;

        // Authentication system
        const AUTH_STORAGE_KEY = 'smk_auth_users';
        const SESSION_KEY = 'smk_current_session';

        // Default admin account
        const defaultUsers = [
            {
                id: 1,
                username: 'admin',
                email: 'admin@smkassuythiyyah.sch.id',
                password: 'admin123',
                role: 'admin',
                createdAt: new Date().toISOString()
            }
        ];

        // Initialize authentication
        function initAuth() {
            // Initialize default users if not exists
            if (!localStorage.getItem(AUTH_STORAGE_KEY)) {
                localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(defaultUsers));
            }
            
            // Check for existing session
            const session = localStorage.getItem(SESSION_KEY);
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    if (sessionData.expires > Date.now()) {
                        currentUser = sessionData.user;
                        showMainApp();
                        return;
                    } else {
                        localStorage.removeItem(SESSION_KEY);
                    }
                } catch (e) {
                    localStorage.removeItem(SESSION_KEY);
                }
            }
            
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Update user display
            if (currentUser) {
                document.getElementById('user-display').textContent = currentUser.username;
            }
            
            // Load data and initialize app
            loadData();
            loadAllData();
            updateDashboard();
            initializeChart();
            populateYearFilter();
        }

        function showLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            const users = JSON.parse(localStorage.getItem(AUTH_STORAGE_KEY) || '[]');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                // Create session
                const session = {
                    user: user,
                    expires: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(session));
                currentUser = user;
                
                showMainApp();
                
                // Set default date
                document.getElementById('absensi-tanggal').value = new Date().toISOString().split('T')[0];
            } else {
                alert('Username atau password salah!');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;
            
            if (password !== confirmPassword) {
                alert('Password dan konfirmasi password tidak sama!');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem(AUTH_STORAGE_KEY) || '[]');
            
            // Check if username or email already exists
            if (users.find(u => u.username === username)) {
                alert('Username sudah digunakan!');
                return;
            }
            
            if (users.find(u => u.email === email)) {
                alert('Email sudah digunakan!');
                return;
            }
            
            // Create new user
            const newUser = {
                id: Date.now(),
                username: username,
                email: email,
                password: password,
                role: 'user',
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(users));
            
            alert('Akun berhasil dibuat! Silakan login.');
            showLogin();
            
            // Clear form
            document.getElementById('register-form').reset();
        }

        function handleLogout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                localStorage.removeItem(SESSION_KEY);
                currentUser = null;
                showLoginScreen();
                
                // Clear forms
                document.getElementById('login-form').reset();
                document.getElementById('register-form').reset();
            }
        }

        // Enhanced cloud storage with user-specific data
        function getStorageKey(key) {
            return currentUser ? `${currentUser.username}_${key}` : key;
        }
        
        function saveToCloud(data) {
            if (!currentUser) return;
            
            const cloudData = {
                timestamp: Date.now(),
                data: data,
                userId: currentUser.id,
                username: currentUser.username
            };
            
            const storageKey = getStorageKey('smk_data');
            localStorage.setItem(storageKey, JSON.stringify(cloudData));
            
            // Also save to a global backup with user identifier
            const globalBackup = JSON.parse(localStorage.getItem('smk_global_backup') || '{}');
            globalBackup[currentUser.username] = cloudData;
            localStorage.setItem('smk_global_backup', JSON.stringify(globalBackup));
        }
        
        function loadFromCloud() {
            if (!currentUser) return null;
            
            const storageKey = getStorageKey('smk_data');
            let cloudData = localStorage.getItem(storageKey);
            
            if (!cloudData) {
                // Try to load from global backup
                const globalBackup = JSON.parse(localStorage.getItem('smk_global_backup') || '{}');
                if (globalBackup[currentUser.username]) {
                    cloudData = JSON.stringify(globalBackup[currentUser.username]);
                }
            }
            
            if (cloudData) {
                try {
                    const parsed = JSON.parse(cloudData);
                    return parsed.data;
                } catch (e) {
                    console.error('Error parsing cloud data:', e);
                }
            }
            return null;
        }
        
        function syncData() {
            if (!currentUser) return;
            
            const allData = {
                kepsek: dataKepsek,
                guru: dataGuru,
                siswa: dataSiswa,
                mapel: dataMapel,
                absensi: dataAbsensi
            };
            saveToCloud(allData);
        }
        
        function loadData() {
            if (!currentUser) return;
            
            const cloudData = loadFromCloud();
            if (cloudData) {
                dataKepsek = cloudData.kepsek || [];
                dataGuru = cloudData.guru || [];
                dataSiswa = cloudData.siswa || [];
                dataMapel = cloudData.mapel || [];
                dataAbsensi = cloudData.absensi || [];
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initAuth();
        });

        // Navigation functions
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-purple-600', 'bg-purple-50');
                btn.classList.add('text-gray-600');
            });
            
            event.target.classList.remove('text-gray-600');
            event.target.classList.add('text-purple-600', 'bg-purple-50');
        }

        function showInputTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.input-tab').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabId + '-form').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.input-tab-btn').forEach(btn => {
                btn.classList.remove('border-purple-600', 'text-purple-600');
                btn.classList.add('text-gray-500');
            });
            
            event.target.classList.remove('text-gray-500');
            event.target.classList.add('border-purple-600', 'text-purple-600');
        }

        // Dashboard functions
        function updateDashboard() {
            document.getElementById('totalKepsek').textContent = dataKepsek.length;
            document.getElementById('totalGuru').textContent = dataGuru.length;
            document.getElementById('totalSiswa').textContent = dataSiswa.length;
            
            // Calculate today's attendance
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = dataAbsensi.filter(a => a.tanggal === today);
            const totalStudentsToday = todayAttendance.length;
            const presentToday = todayAttendance.filter(a => a.status === 'hadir').length;
            const attendancePercentage = totalStudentsToday > 0 ? Math.round((presentToday / totalStudentsToday) * 100) : 0;
            
            document.getElementById('kehadiranHariIni').textContent = attendancePercentage + '%';
        }

        function initializeChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            // Generate sample data for the last 7 days
            const labels = [];
            const data = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('id-ID', { weekday: 'short' }));
                
                // Calculate attendance for this date
                const dateStr = date.toISOString().split('T')[0];
                const dayAttendance = dataAbsensi.filter(a => a.tanggal === dateStr);
                const totalStudents = dayAttendance.length;
                const presentStudents = dayAttendance.filter(a => a.status === 'hadir').length;
                const percentage = totalStudents > 0 ? Math.round((presentStudents / totalStudents) * 100) : Math.floor(Math.random() * 30) + 70;
                
                data.push(percentage);
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Persentase Kehadiran (%)',
                        data: data,
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Data management functions
        function saveKepsek(event) {
            event.preventDefault();
            
            const kepsek = {
                id: currentEditId || Date.now(),
                nip: document.getElementById('kepsek-nip').value,
                nama: document.getElementById('kepsek-nama').value,
                gender: document.getElementById('kepsek-gender').value,
                alamat: document.getElementById('kepsek-alamat').value
            };

            if (currentEditId) {
                const index = dataKepsek.findIndex(k => k.id === currentEditId);
                dataKepsek[index] = kepsek;
                currentEditId = null;
            } else {
                dataKepsek = [kepsek]; // Only one kepala sekolah
            }

            syncData();
            loadKepsekData();
            document.querySelector('#kepsek-form form').reset();
            updateDashboard();
        }

        function saveGuru(event) {
            event.preventDefault();
            
            const guru = {
                id: currentEditId || Date.now(),
                nip: document.getElementById('guru-nip').value,
                nama: document.getElementById('guru-nama').value,
                gender: document.getElementById('guru-gender').value,
                alamat: document.getElementById('guru-alamat').value
            };

            if (currentEditId) {
                const index = dataGuru.findIndex(g => g.id === currentEditId);
                dataGuru[index] = guru;
                currentEditId = null;
            } else {
                dataGuru.push(guru);
            }

            syncData();
            loadGuruData();
            document.querySelector('#guru-form form').reset();
            updateDashboard();
            populateAbsensiGuru();
        }

        function saveSiswa(event) {
            event.preventDefault();
            
            const siswa = {
                id: currentEditId || Date.now(),
                nis: document.getElementById('siswa-nis').value,
                nisn: document.getElementById('siswa-nisn').value,
                nama: document.getElementById('siswa-nama').value,
                gender: document.getElementById('siswa-gender').value,
                kelas: document.getElementById('siswa-kelas').value
            };

            if (currentEditId) {
                const index = dataSiswa.findIndex(s => s.id === currentEditId);
                dataSiswa[index] = siswa;
                currentEditId = null;
            } else {
                dataSiswa.push(siswa);
            }

            syncData();
            loadSiswaData();
            document.querySelector('#siswa-form form').reset();
            updateDashboard();
            populateAbsensiKelas();
            populateFilterKelas();
        }

        function saveMapel(event) {
            event.preventDefault();
            
            const mapel = {
                id: currentEditId || Date.now(),
                kode: document.getElementById('mapel-kode').value,
                nama: document.getElementById('mapel-nama').value
            };

            if (currentEditId) {
                const index = dataMapel.findIndex(m => m.id === currentEditId);
                dataMapel[index] = mapel;
                currentEditId = null;
            } else {
                dataMapel.push(mapel);
            }

            syncData();
            loadMapelData();
            document.querySelector('#mapel-form form').reset();
            populateAbsensiMapel();
        }

        // Load data functions
        function loadAllData() {
            loadKepsekData();
            loadGuruData();
            loadSiswaData();
            loadMapelData();
            populateAbsensiGuru();
            populateAbsensiMapel();
            populateAbsensiKelas();
            populateFilterKelas();
        }

        function loadKepsekData() {
            const tbody = document.getElementById('kepsek-table-body');
            tbody.innerHTML = '';
            
            dataKepsek.forEach(kepsek => {
                const row = `
                    <tr>
                        <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${kepsek.nip}</td>
                        <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${kepsek.nama}</td>
                        <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${kepsek.gender === 'L' ? 'L' : 'P'}</td>
                        <td class="px-3 sm:px-6 py-2 sm:py-4 text-xs sm:text-sm text-gray-900 max-w-xs truncate">${kepsek.alamat}</td>
                        <td class="px-3 sm:px-6 py-2 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium">
                            <button onclick="editData('kepsek', ${kepsek.id})" class="text-indigo-600 hover:text-indigo-900 mr-2 sm:mr-3 text-xs sm:text-sm">Edit</button>
                            <button onclick="deleteData('kepsek', ${kepsek.id})" class="text-red-600 hover:text-red-900 text-xs sm:text-sm">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function loadGuruData() {
            const tbody = document.getElementById('guru-table-body');
            tbody.innerHTML = '';
            
            dataGuru.forEach(guru => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.nip}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${guru.alamat}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editData('guru', ${guru.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="deleteData('guru', ${guru.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function loadSiswaData() {
            const tbody = document.getElementById('siswa-table-body');
            tbody.innerHTML = '';
            
            dataSiswa.forEach(siswa => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nis}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nisn}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${siswa.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editData('siswa', ${siswa.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="deleteData('siswa', ${siswa.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function loadMapelData() {
            const tbody = document.getElementById('mapel-table-body');
            tbody.innerHTML = '';
            
            dataMapel.forEach(mapel => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${mapel.kode}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${mapel.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editData('mapel', ${mapel.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="deleteData('mapel', ${mapel.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Edit and delete functions
        function editData(type, id) {
            currentEditId = id;
            currentEditType = type;
            
            let data, form;
            
            switch(type) {
                case 'kepsek':
                    data = dataKepsek.find(k => k.id === id);
                    document.getElementById('kepsek-nip').value = data.nip;
                    document.getElementById('kepsek-nama').value = data.nama;
                    document.getElementById('kepsek-gender').value = data.gender;
                    document.getElementById('kepsek-alamat').value = data.alamat;
                    break;
                case 'guru':
                    data = dataGuru.find(g => g.id === id);
                    document.getElementById('guru-nip').value = data.nip;
                    document.getElementById('guru-nama').value = data.nama;
                    document.getElementById('guru-gender').value = data.gender;
                    document.getElementById('guru-alamat').value = data.alamat;
                    break;
                case 'siswa':
                    data = dataSiswa.find(s => s.id === id);
                    document.getElementById('siswa-nis').value = data.nis;
                    document.getElementById('siswa-nisn').value = data.nisn;
                    document.getElementById('siswa-nama').value = data.nama;
                    document.getElementById('siswa-gender').value = data.gender;
                    document.getElementById('siswa-kelas').value = data.kelas;
                    break;
                case 'mapel':
                    data = dataMapel.find(m => m.id === id);
                    document.getElementById('mapel-kode').value = data.kode;
                    document.getElementById('mapel-nama').value = data.nama;
                    break;
            }
        }

        function deleteData(type, id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
            
            switch(type) {
                case 'kepsek':
                    dataKepsek = dataKepsek.filter(k => k.id !== id);
                    syncData();
                    loadKepsekData();
                    break;
                case 'guru':
                    dataGuru = dataGuru.filter(g => g.id !== id);
                    syncData();
                    loadGuruData();
                    populateAbsensiGuru();
                    break;
                case 'siswa':
                    dataSiswa = dataSiswa.filter(s => s.id !== id);
                    syncData();
                    loadSiswaData();
                    populateAbsensiKelas();
                    populateFilterKelas();
                    break;
                case 'mapel':
                    dataMapel = dataMapel.filter(m => m.id !== id);
                    syncData();
                    loadMapelData();
                    populateAbsensiMapel();
                    break;
            }
            updateDashboard();
        }

        // Excel functions
        function downloadTemplate(type) {
            let data, filename;
            
            switch(type) {
                case 'guru':
                    data = [['NIP/NUPTK', 'Nama', 'Jenis Kelamin (L/P)', 'Alamat']];
                    filename = 'template_guru.xlsx';
                    break;
                case 'siswa':
                    data = [['NIS', 'NISN', 'Nama', 'Jenis Kelamin (L/P)', 'Kelas']];
                    filename = 'template_siswa.xlsx';
                    break;
                case 'mapel':
                    data = [['Kode', 'Nama Mata Pelajaran']];
                    filename = 'template_mata_pelajaran.xlsx';
                    break;
            }
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, filename);
        }

        function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file Excel terlebih dahulu!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                // Process based on file structure
                processExcelData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            if (data.length < 2) {
                alert('File Excel tidak valid!');
                return;
            }
            
            const headers = data[0];
            const rows = data.slice(1);
            
            // Detect data type based on headers
            if (headers.includes('NIP/NUPTK') && headers.length === 4) {
                // Guru data
                rows.forEach(row => {
                    if (row.length >= 4) {
                        dataGuru.push({
                            id: Date.now() + Math.random(),
                            nip: row[0],
                            nama: row[1],
                            gender: row[2],
                            alamat: row[3]
                        });
                    }
                });
                syncData();
                loadGuruData();
                populateAbsensiGuru();
            } else if (headers.includes('NIS') && headers.includes('NISN')) {
                // Siswa data
                rows.forEach(row => {
                    if (row.length >= 5) {
                        dataSiswa.push({
                            id: Date.now() + Math.random(),
                            nis: row[0],
                            nisn: row[1],
                            nama: row[2],
                            gender: row[3],
                            kelas: row[4]
                        });
                    }
                });
                syncData();
                loadSiswaData();
                populateAbsensiKelas();
                populateFilterKelas();
            } else if (headers.includes('Kode') && headers.length === 2) {
                // Mapel data
                rows.forEach(row => {
                    if (row.length >= 2) {
                        dataMapel.push({
                            id: Date.now() + Math.random(),
                            kode: row[0],
                            nama: row[1]
                        });
                    }
                });
                syncData();
                loadMapelData();
                populateAbsensiMapel();
            }
            
            updateDashboard();
            alert('Data berhasil diimport!');
        }

        function downloadData(type) {
            let data, filename;
            
            switch(type) {
                case 'guru':
                    data = [['NIP/NUPTK', 'Nama', 'Jenis Kelamin', 'Alamat']];
                    dataGuru.forEach(guru => {
                        data.push([guru.nip, guru.nama, guru.gender === 'L' ? 'Laki-laki' : 'Perempuan', guru.alamat]);
                    });
                    filename = 'data_guru.xlsx';
                    break;
                case 'siswa':
                    data = [['NIS', 'NISN', 'Nama', 'Jenis Kelamin', 'Kelas']];
                    dataSiswa.forEach(siswa => {
                        data.push([siswa.nis, siswa.nisn, siswa.nama, siswa.gender === 'L' ? 'Laki-laki' : 'Perempuan', siswa.kelas]);
                    });
                    filename = 'data_siswa.xlsx';
                    break;
                case 'mapel':
                    data = [['Kode', 'Nama Mata Pelajaran']];
                    dataMapel.forEach(mapel => {
                        data.push([mapel.kode, mapel.nama]);
                    });
                    filename = 'data_mata_pelajaran.xlsx';
                    break;
            }
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, filename);
        }

        // Absensi functions
        function populateAbsensiGuru() {
            const select = document.getElementById('absensi-guru');
            select.innerHTML = '<option value="">Pilih Guru</option>';
            
            dataGuru.forEach(guru => {
                select.innerHTML += `<option value="${guru.id}">${guru.nama}</option>`;
            });
        }

        function populateAbsensiMapel() {
            const select = document.getElementById('absensi-mapel');
            select.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
            
            dataMapel.forEach(mapel => {
                select.innerHTML += `<option value="${mapel.id}">${mapel.nama}</option>`;
            });
        }

        function populateAbsensiKelas() {
            const select = document.getElementById('absensi-kelas');
            const kelasSet = new Set();
            
            dataSiswa.forEach(siswa => {
                kelasSet.add(siswa.kelas);
            });
            
            select.innerHTML = '<option value="">Pilih Kelas</option>';
            kelasSet.forEach(kelas => {
                select.innerHTML += `<option value="${kelas}">${kelas}</option>`;
            });
        }

        function loadAbsensiSiswa() {
            const guruId = document.getElementById('absensi-guru').value;
            const tanggal = document.getElementById('absensi-tanggal').value;
            const mapelId = document.getElementById('absensi-mapel').value;
            const kelas = document.getElementById('absensi-kelas').value;
            
            if (!guruId || !tanggal || !mapelId || !kelas) {
                alert('Lengkapi semua field terlebih dahulu!');
                return;
            }
            
            const guru = dataGuru.find(g => g.id == guruId);
            const mapel = dataMapel.find(m => m.id == mapelId);
            
            // Update info display
            document.getElementById('info-guru').textContent = guru.nama;
            document.getElementById('info-tanggal').textContent = new Date(tanggal).toLocaleDateString('id-ID');
            document.getElementById('info-mapel').textContent = mapel.nama;
            document.getElementById('info-kelas').textContent = kelas;
            document.getElementById('absensi-info').classList.remove('hidden');
            
            // Load students for the class
            const siswaKelas = dataSiswa.filter(s => s.kelas === kelas);
            const grid = document.getElementById('absensi-grid');
            grid.innerHTML = '';
            
            siswaKelas.forEach(siswa => {
                // Check if attendance already exists
                const existingAbsensi = dataAbsensi.find(a => 
                    a.siswaId == siswa.id && 
                    a.tanggal === tanggal && 
                    a.mapelId == mapelId
                );
                
                const card = `
                    <div class="bg-white rounded-lg p-3 sm:p-4 card-shadow">
                        <h4 class="font-semibold text-gray-800 mb-3 text-sm sm:text-base truncate">${siswa.nama}</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="absensi-${siswa.id}" value="hadir" class="mr-2 text-green-600 flex-shrink-0" ${existingAbsensi?.status === 'hadir' ? 'checked' : ''}>
                                <span class="text-green-600 text-sm">Hadir</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="absensi-${siswa.id}" value="sakit" class="mr-2 text-yellow-600 flex-shrink-0" ${existingAbsensi?.status === 'sakit' ? 'checked' : ''}>
                                <span class="text-yellow-600 text-sm">Sakit</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="absensi-${siswa.id}" value="ijin" class="mr-2 text-blue-600 flex-shrink-0" ${existingAbsensi?.status === 'ijin' ? 'checked' : ''}>
                                <span class="text-blue-600 text-sm">Ijin</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="absensi-${siswa.id}" value="alpha" class="mr-2 text-red-600 flex-shrink-0" ${existingAbsensi?.status === 'alpha' ? 'checked' : ''}>
                                <span class="text-red-600 text-sm">Alpha</span>
                            </label>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
            
            document.getElementById('absensi-actions').classList.remove('hidden');
        }

        function saveAbsensi() {
            const guruId = document.getElementById('absensi-guru').value;
            const tanggal = document.getElementById('absensi-tanggal').value;
            const mapelId = document.getElementById('absensi-mapel').value;
            const kelas = document.getElementById('absensi-kelas').value;
            
            const siswaKelas = dataSiswa.filter(s => s.kelas === kelas);
            
            // Remove existing attendance for this date/class/subject
            dataAbsensi = dataAbsensi.filter(a => 
                !(a.tanggal === tanggal && a.mapelId == mapelId && siswaKelas.some(s => s.id == a.siswaId))
            );
            
            // Add new attendance records
            siswaKelas.forEach(siswa => {
                const statusRadio = document.querySelector(`input[name="absensi-${siswa.id}"]:checked`);
                if (statusRadio) {
                    dataAbsensi.push({
                        id: Date.now() + Math.random(),
                        siswaId: siswa.id,
                        guruId: guruId,
                        mapelId: mapelId,
                        tanggal: tanggal,
                        kelas: kelas,
                        status: statusRadio.value
                    });
                }
            });
            
            syncData();
            alert('Absensi berhasil disimpan!');
            updateDashboard();
        }

        // Output functions
        function populateFilterKelas() {
            const select = document.getElementById('filter-kelas');
            const kelasSet = new Set();
            
            dataSiswa.forEach(siswa => {
                kelasSet.add(siswa.kelas);
            });
            
            select.innerHTML = '<option value="">Semua Kelas</option>';
            kelasSet.forEach(kelas => {
                select.innerHTML += `<option value="${kelas}">${kelas}</option>`;
            });
        }

        function populateYearFilter() {
            const select = document.getElementById('filter-tahun');
            
            for (let year = 2025; year <= 2030; year++) {
                const selected = year === 2025 ? 'selected' : '';
                select.innerHTML += `<option value="${year}" ${selected}>${year}</option>`;
            }
        }

        function generateRekap() {
            const kelas = document.getElementById('filter-kelas').value;
            const bulan = document.getElementById('filter-bulan').value;
            const tahun = document.getElementById('filter-tahun').value;
            
            if (!tahun) {
                alert('Pilih tahun terlebih dahulu!');
                return;
            }
            
            let filteredAbsensi = dataAbsensi.filter(a => {
                const absensiDate = new Date(a.tanggal);
                const absensiYear = absensiDate.getFullYear();
                const absensiMonth = String(absensiDate.getMonth() + 1).padStart(2, '0');
                
                let matches = absensiYear == tahun;
                
                if (bulan) {
                    matches = matches && absensiMonth === bulan;
                }
                
                if (kelas) {
                    matches = matches && a.kelas === kelas;
                }
                
                return matches;
            });
            
            displayRekapPreview(filteredAbsensi, kelas, bulan, tahun);
        }

        function displayRekapPreview(absensiData, kelas, bulan, tahun) {
            const content = document.getElementById('rekap-content');
            
            if (absensiData.length === 0) {
                content.innerHTML = '<p class="text-gray-500 text-center py-8">Tidak ada data absensi untuk filter yang dipilih</p>';
                return;
            }
            
            // Group by student
            const groupedData = {};
            absensiData.forEach(a => {
                const siswa = dataSiswa.find(s => s.id == a.siswaId);
                if (!siswa) return;
                
                if (!groupedData[siswa.id]) {
                    groupedData[siswa.id] = {
                        siswa: siswa,
                        hadir: 0,
                        sakit: 0,
                        ijin: 0,
                        alpha: 0,
                        total: 0
                    };
                }
                
                groupedData[siswa.id][a.status]++;
                groupedData[siswa.id].total++;
            });
            
            let tableHTML = `
                <div class="mb-4">
                    <h4 class="text-lg font-semibold">Rekap Absensi ${kelas ? 'Kelas ' + kelas : 'Semua Kelas'}</h4>
                    <p class="text-gray-600">Periode: ${bulan ? getMonthName(bulan) + ' ' : ''}${tahun}</p>
                </div>
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sakit</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ijin</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Persentase</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            let no = 1;
            Object.values(groupedData).forEach(data => {
                const persentase = data.total > 0 ? Math.round((data.hadir / data.total) * 100) : 0;
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${no++}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.siswa.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.siswa.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${data.hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600">${data.sakit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">${data.ijin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${data.alpha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data.total}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${persentase}%</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            content.innerHTML = tableHTML;
        }

        function getMonthName(monthNum) {
            const months = [
                '', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            return months[parseInt(monthNum)];
        }

        function exportToExcel(type) {
            const kelas = document.getElementById('filter-kelas').value;
            const bulan = document.getElementById('filter-bulan').value;
            const tahun = document.getElementById('filter-tahun').value;
            
            if (!tahun) {
                alert('Pilih tahun terlebih dahulu!');
                return;
            }
            
            let filteredAbsensi = dataAbsensi.filter(a => {
                const absensiDate = new Date(a.tanggal);
                const absensiYear = absensiDate.getFullYear();
                const absensiMonth = String(absensiDate.getMonth() + 1).padStart(2, '0');
                
                let matches = absensiYear == tahun;
                
                if (type === 'bulanan' && bulan) {
                    matches = matches && absensiMonth === bulan;
                }
                
                if (kelas) {
                    matches = matches && a.kelas === kelas;
                }
                
                return matches;
            });
            
            if (filteredAbsensi.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            // Group by student
            const groupedData = {};
            filteredAbsensi.forEach(a => {
                const siswa = dataSiswa.find(s => s.id == a.siswaId);
                if (!siswa) return;
                
                if (!groupedData[siswa.id]) {
                    groupedData[siswa.id] = {
                        siswa: siswa,
                        hadir: 0,
                        sakit: 0,
                        ijin: 0,
                        alpha: 0,
                        total: 0
                    };
                }
                
                groupedData[siswa.id][a.status]++;
                groupedData[siswa.id].total++;
            });
            
            // Prepare Excel data
            const excelData = [
                ['REKAP ABSENSI SISWA'],
                ['SMK ASSUYTHIYYAH'],
                [''],
                [`Periode: ${type === 'bulanan' && bulan ? getMonthName(bulan) + ' ' : ''}${tahun}`],
                [`Kelas: ${kelas || 'Semua Kelas'}`],
                [''],
                ['No', 'NIS', 'Nama Siswa', 'Kelas', 'Hadir', 'Sakit', 'Ijin', 'Alpha', 'Total', 'Persentase Kehadiran']
            ];
            
            let no = 1;
            Object.values(groupedData).forEach(data => {
                const persentase = data.total > 0 ? Math.round((data.hadir / data.total) * 100) : 0;
                excelData.push([
                    no++,
                    data.siswa.nis,
                    data.siswa.nama,
                    data.siswa.kelas,
                    data.hadir,
                    data.sakit,
                    data.ijin,
                    data.alpha,
                    data.total,
                    persentase + '%'
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Rekap Absensi');
            
            const filename = `rekap_absensi_${type}_${tahun}${bulan ? '_' + bulan : ''}${kelas ? '_' + kelas : ''}.xlsx`;
            XLSX.writeFile(wb, filename);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'963000388037fe11',t:'MTc1MzE1NjUwOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
